<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>OLX</title>

    <script> src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"</script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script> src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"</script>
    <script src="/socket.io/socket.io.js"></script>

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</head>
<body>
    <div  class="jumbotron mb-0 mt-4">
        <h1 class="display-4">
            <a href="http://localhost:3000/home" class="title">
                OLX
            </a>
        </h1>
    </div>

    <div class="container"> </div>
    <nav class="navbar navbar-expand navbar-light bg-light d-flex justify-content-between mb-3" id="top-menu">
        <div class="navbar-nav">
            <a class="nav-item nav-link" href="/#">Todos</a>
            <a class="nav-item nav-link" href="/#">Aguardando</a>
            <a class="nav-item nav-link" href="/#">Aprovado</a>
            <a class="nav-item nav-link" href="/#">Entregue</a>
        </div>
        <a href="http://localhost:3000/novoproduto"><button class="btn btn-outline-secondary my-2 my-sm-0 newproduct">Novo produto</button></a>
    </nav>
    <nav class="navbar navbar-light">
        <form class="form-inline" id="searchbar">
            <input class="form-control mr-sm-2" id="searchinput" type="search" placeholder="Buscar produto" aria-label="Search">
            <button class="btn btn-outline-light my-2 my-sm-0" type="submit">Buscar</button>
        </form>
    </nav>
    <div class="card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-12 col-sm-8 mb-3">
                    <div class="product-name">
                        <div class="col">
                            <h4 class="display-4">Nome Produto</h4>
                        </div>
                    </div>               
                </div>  
                <div class="col-12 product-info">
                    <div class="product-img">
                        <img class="img-thumbnail"  src="https://blog.weddingbrasil.com.br/wp-content/uploads/2015/07/David-Beckstead-7.jpg" />
                    </div>
                    <div class="compra-info">
                        <button onclick="comprar()" class="btn btn-success btn-lg my-2 my-sm-0 buy">Comprar</button>
                        <div class="col">
                            <p>Alguma dúvida sobre o produto?</p> 
                            <p>Fale com o vendedor pelo nosso chat</p> 
                        </div>
                        <a href="http://localhost:3000/chat"><button class="btn btn-outline-secondary my-2 my-sm-0 chat">chat</button></a>
                    </div>
                </div>
                <div class="product-price">
                    <div class="col">
                        <span>R$200</span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-sm-8 mb-3">
                    <div class = "product-details">
                        <div class="col">
                            <span>Gumball maravilhado com um celular</span>
                        </div>
                    </div>            
                </div>
            </div>
            <div class="line-break"></div>
            <div class="row">
                <div class="col-12 col-sm-8 mb-3">
                    <!--Referencia: https://www.w3schools.com/howto/howto_css_user_rating.asp-->
                    <div class="avaliacao-vendedor">
                        <span class="heading">Avaliação do Vendedor</span>
                        <div></div>
                        <span class="media-avaliacoes">-</span>
                        <a>média baseada em</a>
                        <span class="total-avaliacoes">-</span>
                        <a>reviews.</a>
                        <hr style="border:3px solid #f1f1f1">

                        <div class="row">
                            <div class="side">
                                <div class="btn-group" role="group" aria-label="Third group">
                                    <button onclick="avaliaUsuario(5)" type="button" class="btn btn-success">5</button>
                                  </div>
                            </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-5"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <span class="5-star-rating">0</span>
                        </div>
                        <div class="side">
                            <div class="btn-group" role="group" aria-label="Third group">
                                <button onclick="avaliaUsuario(4)" type="button" class="btn btn-primary">4</button>
                              </div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                            <div class="bar-4"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <span class="4-star-rating">0</span>
                        </div>
                        <div class="side">
                            <div class="btn-group" role="group" aria-label="Third group">
                                <button onclick="avaliaUsuario(3)" type="button" class="btn btn-info">3</button>
                              </div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                            <div class="bar-3"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <span class="3-star-rating">0</span>
                        </div>
                        <div class="side">
                            <div class="btn-group" role="group" aria-label="Third group">
                                <button onclick="avaliaUsuario(2)" type="button" class="btn btn-warning">2</button>
                              </div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                            <div class="bar-2"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <span class="2-star-rating">0</span>
                        </div>
                        <div class="side">
                            <div class="btn-group" role="group" aria-label="Third group">
                                <button onclick="avaliaUsuario(1)" type="button" class="btn btn-danger">1</button>
                              </div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                            <div class="bar-1"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <span class="1-star-rating">0</span>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <script src="./cookies.js"></script>

    <script type= "text/javascript">     

     var socket = io('http://localhost:3000', {
        query: {
            token: getCookie('token')
        }
      });

      //socket recebe avaliação
      socket.on('recebeAvaliacao', (data) => {
            console.log(data)
            alert('recebeu um voto: ' + JSON.stringify(data));
            atualizaReviews(data["5 estrelas"],data["4 estrelas"],data["3 estrelas"],data["2 estrelas"],data["1 estrelas"]);
        })

        var nomeProduto;

        let donoProdutoId;
        //metodo para avaliar usuario
        function avaliaUsuario(estrelas) {

            switch(estrelas) {
                case 0:
                enviaAvalicao(0)
                break;
                case 1:
                enviaAvalicao(1)
                break;
                case 2:
                enviaAvalicao(2)
                break;
                case 3:
                enviaAvalicao(3)
                break;
                case 4:
                enviaAvalicao(4)
                break;
                case 5:
                enviaAvalicao(5)
                break;

            }
        }

        //socket de emissão de avaliação quando é o usuário é avaliado na página
        function enviaAvalicao(rate) {
            alert('avaliando usuario: ' + donoProdutoId)
            socket.emit('avaliaUsuario', {
                token: getCookie('token'),
                rate,
                userRatedId: donoProdutoId
            })
        }

        //Funcao que altera a pagina do padrao do produto com suas proprias infos
        function atualizaInfos(){
            var queryString = decodeURIComponent(window.location.search);
            var info = [];
            queryString = queryString.replace(/\+/g, ' ');
            queryString = queryString.substring(1);
            var queries = queryString.split("&");

            for (var i = 0; i < queries.length; i++){
                var aux = queries[i].split("=")[1];
                info.push(aux);
            }

            $(".product-name h4").text(info[0]);
            nomeProduto = info[0];
            document.title = nomeProduto;
            $(".product-details span").text(info[1]);
            $(".product-price span").text("R$" + info[2].replace(',','.'));
            $(".product-img img").attr("src",info[3]);
            donoProdutoId = info[4]
        }
        
        //Funcao que atualiza vizualmente a avaliação do vendedor na pagina do produto
        function atualizaReviews(qtd5stars, qtd4stars, qtd3stars, qtd2stars, qtd1star){
            var total = qtd5stars + qtd4stars + qtd3stars + qtd2stars + qtd1star;
            $(".total-avaliacoes").text(total);

            if(total==0) total=1;

            var media = ((5*qtd5stars) + (4*qtd4stars) + (3*qtd3stars) + (2*qtd2stars) + (1*qtd1star))/total;
            $(".media-avaliacoes").text(media.toFixed(1));

            $(".bar-5").css("width", (qtd5stars*100)/total + "%");
            $(".5-star-rating").text(qtd5stars);
            $(".bar-4").css("width", (qtd4stars*100)/total + "%");
            $(".4-star-rating").text(qtd4stars);
            $(".bar-3").css("width", (qtd3stars*100)/total + "%");
            $(".3-star-rating").text(qtd3stars);
            $(".bar-2").css("width", (qtd2stars*100)/total + "%");
            $(".2-star-rating").text(qtd2stars);
            $(".bar-1").css("width", (qtd1star*100)/total + "%");
            $(".1-star-rating").text(qtd1star);
        }

        function votar(voto) {
            switch(voto) {
                    case 5:
                    atualizaReviews(1,0,0,0,0);
                    break;
                    case 4:
                    atualizaReviews(0,1,0,0,0);
                    break;
                    case 3:
                    atualizaReviews(0,0,1,0,0);
                    break;
                    case 2:
                    atualizaReviews(0,0,0,1,0);
                    break;
                    default:
                    atualizaReviews(0,0,0,0,1);
                    break;
            }
        }
        atualizaInfos();
        //socket que emite que o item foi comprado e retira da lista de produtos
        function comprar() {
            alert("produto comprado!!!")
            socket.emit('comprarproduto', nomeProduto);
        }


        
        //atualizaReviews(5,8,2,1,6);

    </script>
</body>
</html>